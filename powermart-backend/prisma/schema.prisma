// ---------------------
//  Prisma Generator
// ---------------------
generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

// ---------------------
// Enumerations
// ---------------------
enum UserRole {
  USER
  VENDOR
  ADMIN
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum KYCDocumentType {
  CNIC
  PASSPORT
  LICENSE
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  COD
  CARD
}

enum OrderItemStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

// ---------------------
// User & Auth
// ---------------------
model User {
  id            String           @id @default(uuid())
  email         String           @unique
  password      String
  name          String?
  role          UserRole         @default(USER)
  isVendor      Boolean          @default(false)
  isAdmin       Boolean          @default(false)
  status        AccountStatus    @default(ACTIVE)
  isVerified    Boolean          @default(false)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  refreshTokens       RefreshToken[]
  emailOTPs           EmailOTP[]
  passwordResetTokens PasswordResetToken[]
  vendor              Vendor?
  orders              Order[]
  orderAddresses      OrderAddress[]
  reviews             ProductReview[]
  cart                Cart?

  @@index([email])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ---------------------
// Email Verification OTP
// ---------------------
model EmailOTP {
  id          String     @id @default(uuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  email       String
  otpCode     String
  expiresAt   DateTime
  verified    Boolean    @default(false)
  attempts    Int        @default(0)
  createdAt   DateTime   @default(now())

  @@index([userId])
  @@index([email])
  @@map("email_otp")
}

// ---------------------
// Password Reset Token
// ---------------------
model PasswordResetToken {
  id          String     @id @default(uuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  token       String     @unique
  expiresAt   DateTime
  used        Boolean    @default(false)
  createdAt   DateTime   @default(now())

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

// ---------------------
// Vendor Data Layer
// ---------------------
model Vendor {
  id          String       @id @default(uuid())
  userId      String       @unique
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  phoneNumber    String    @unique
  phoneVerified  Boolean          @default(false)
  address     String?
  website     String?

  shops       Shop[]
  kyc         VendorKYC?
  phoneOTPs   PhoneOTP[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([userId])
  @@map("vendors")
}

// ---------------------
// Vendor KYC (Main)
// ---------------------
model VendorKYC {
  id             String           @id @default(uuid())
  vendorId       String           @unique
  vendor         Vendor           @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  status         KYCStatus        @default(PENDING)
  submittedAt    DateTime         @default(now())
  reviewedAt     DateTime?

  documents      KYCDocument[]
  bankDetails    VendorBankDetails[]

  @@index([vendorId])
  @@map("vendor_kyc")
}

// ---------------------
// KYC Documents (Multiple)
// ---------------------
model KYCDocument {
  id             String            @id @default(uuid())
  kycId          String
  kyc            VendorKYC         @relation(fields: [kycId], references: [id], onDelete: Cascade)
  documentType   KYCDocumentType
  documentNumber String
  frontImageURL  String?
  backImageURL   String?

  uploadedAt     DateTime          @default(now())

  @@index([kycId])
  @@map("kyc_documents")
}

// ---------------------
// Vendor Bank Details
// ---------------------
model VendorBankDetails {
  id            String       @id @default(uuid())
  kycId         String
  kyc           VendorKYC    @relation(fields: [kycId], references: [id], onDelete: Cascade)

  accountTitle  String
  bankName      String
  branchName    String?
  branchCode    String?
  iban          String?
  accountNumber String

  isPrimary     Boolean      @default(false)

  createdAt     DateTime     @default(now())

  @@index([kycId])
  @@map("vendor_bank_details")
}

// ---------------------
// OTP for Phone Verification
// ---------------------
model PhoneOTP {
  id          String     @id @default(uuid())
  vendorId    String
  phoneNumber String

  otpCode     String
  expiresAt   DateTime
  verified    Boolean    @default(false)
  attempts    Int        @default(0)

  createdAt   DateTime   @default(now())

  vendor      Vendor     @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([phoneNumber])
  @@map("phone_otp")
}

// ---------------------
// Shops
// ---------------------
model Shop {
  id          String      @id @default(uuid())
  vendorId    String
  vendor      Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  name        String
  description String?
  address     String?
  logo        String?

  products    Product[]
  orderItems  OrderItem[]

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([vendorId])
  @@map("shops")
}

// ---------------------
// Products
// ---------------------
model Product {
  id          String           @id @default(uuid())
  shopId      String
  shop        Shop             @relation(fields: [shopId], references: [id], onDelete: Cascade)

  name        String
  description String?
  price       Float
  discount    Float?
  status      ProductStatus    @default(ACTIVE)

  stock       Int              @default(0)
  sku         String?          @unique

  deliveryCharge Float         @default(0)

  categoryId  String?
  category    Category?        @relation(fields: [categoryId], references: [id])

  images      ProductImage[]
  variants    ProductVariant[]
  orderItems  OrderItem[]
  reviews     ProductReview[]
  cartItems   CartItem[]

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([shopId])
  @@index([categoryId])
  @@map("products")
}

// ---------------------
// Product Images
// ---------------------
model ProductImage {
  id         String      @id @default(uuid())
  productId  String
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  url        String

  createdAt  DateTime    @default(now())

  @@index([productId])
  @@map("product_images")
}

// ---------------------
// Product Variants
// ---------------------
model ProductVariant {
  id          String      @id @default(uuid())
  productId   String
  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  name        String
  value       String
  priceDiff   Float?
  stock       Int         @default(0)

  orderItems  OrderItem[]
  cartItems   CartItem[]

  createdAt   DateTime    @default(now())

  @@index([productId])
  @@map("product_variants")
}

// ---------------------
// Product Reviews
// ---------------------
model ProductReview {
  id                 String        @id @default(uuid())
  productId          String
  product            Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId             String
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderId            String
  order              Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderItemId        String
  orderItem          OrderItem     @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  rating             Int
  comment            String?
  isVerifiedPurchase Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@unique([productId, userId, orderItemId])
  @@index([productId])
  @@index([userId])
  @@index([orderId])
  @@index([orderItemId])
  @@map("product_reviews")
}

// ---------------------
// Cart
// ---------------------
model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("carts")
}

model CartItem {
  id          String     @id @default(uuid())
  cartId      String
  cart        Cart       @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId   String
  product     Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId   String?
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  quantity    Int
  priceSnapshot Float
  deliveryChargeSnapshot Float
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

// ---------------------
// Category System (Hierarchical)
// ---------------------
model Category {
  id          String       @id @default(uuid())
  name        String
  slug        String       @unique
  description String?
  image       String?
  
  // Self-referential relation for subcategories
  parentId    String?
  parent      Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[]   @relation("CategoryHierarchy")
  
  // Products in this category
  products    Product[]
  
  isActive    Boolean      @default(true)
  sortOrder   Int          @default(0)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([parentId])
  @@index([slug])
  @@map("categories")
}

// ---------------------
// Order Address
// ---------------------
model OrderAddress {
  id          String   @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName    String
  phoneNumber String

  line1       String
  line2       String?
  city        String
  state       String?
  postalCode  String?
  country     String

  notes       String?

  createdAt   DateTime @default(now())

  orders      Order[]

  @@map("order_addresses")
}

// ---------------------
// Orders
// ---------------------
model Order {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  orderNumber       String         @unique

  status            OrderStatus    @default(PENDING)
  paymentStatus     PaymentStatus?  
  paymentMethod     PaymentMethod?

  trackingCode      String?
  carrier           String?
  trackingUrl       String?
  estimatedDelivery DateTime?
  deliveredAt       DateTime?

  subtotalAmount    Float
  discountAmount    Float          @default(0)
  shippingFee       Float          @default(0)
  totalAmount       Float

  notes             String?

  shippingAddressId String
  shippingAddress   OrderAddress   @relation(fields: [shippingAddressId], references: [id], onDelete: Cascade)

  items             OrderItem[]
  reviews           ProductReview[]

  placedAt          DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([userId])
  @@index([orderNumber])
  @@map("orders")
}

// ---------------------
// Order Items
// ---------------------
model OrderItem {
  id          String         @id @default(uuid())
  orderId     String
  order       Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId   String
  product     Product        @relation(fields: [productId], references: [id])

  shopId      String
  shop        Shop           @relation(fields: [shopId], references: [id])

  variantId   String?
  variant     ProductVariant? @relation(fields: [variantId], references: [id])

  quantity    Int            @default(1)
  unitPrice   Float
  deliveryCharge Float        @default(0)
  totalPrice  Float

  status      OrderItemStatus @default(PENDING)
  trackingCode String?
  carrier     String?
  trackingUrl String?
  deliveredAt DateTime?

  reviews     ProductReview[]

  createdAt   DateTime       @default(now())

  @@index([orderId])
  @@index([productId])
  @@index([shopId])
  @@map("order_items")
}

